{% extends 'todo/base.html' %}
{% load static %}

{% block title %}My Tasks - TaskMitra{% endblock title %}

{% block styles %}
    {# Link the page-specific stylesheet #}
    <link rel="stylesheet" href="{% static 'todo/css/my-tasks.css' %}">
{% endblock styles %}

{% block content %}
<!-- Filter and Sort Bar (Functionality to be added with JavaScript or form submission) -->
<div class="filter-bar">
    <div class="filter-options">
        <div class="filter-group">
            <label for="sort-by">Sort By:</label>
            <select id="sort-by">
                <option value="date-created">Date Created</option>
                <option value="due-date">Due Date</option>
                <option value="priority">Priority</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-status">Status:</label>
            <select id="filter-status">
                <option value="all">All</option>
                <option value="not-started">Not Started</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
        </div>
    </div>
    <button class="invite-btn" type="button" aria-label="Add new task">
        <i class="fas fa-plus" aria-hidden="true"></i> Add Task
    </button>
</div>

<!-- Grid for All Task Cards -->
<div id="my-tasks-grid">
    {% for task in tasks %}
    <article 
        class="my-task-card priority-{{ task.priority }} status-{{ task.status|slugify }}" 
        tabindex="0" 
        role="button" 
        aria-label="View details for {{ task.title }}"
        data-task-id="{{ task.id }}"
        data-task-detail-url="{% url 'task_detail' task.id %}"> {# URL for fetching details #}
        
        <div class="card-content">
            <h3 class="card-title">{{ task.title }}</h3>
            {% if task.description %}
            <p class="card-description">{{ task.description|truncatewords:15 }}</p>
            {% endif %}
        </div>
        <div class="card-footer">
            {% if task.due_date %}
            <span class="card-due-date"><i class="fas fa-calendar-alt"></i> {{ task.due_date|date:"d M, Y" }}</span>
            {% endif %}
            <span class="card-status status-{{ task.status|slugify }}">{{ task.get_status_display }}</span>
        </div>
    </article>
    {% empty %}
    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
        <div class="empty-icon"><i class="fas fa-tasks"></i></div>
        <h4>You have no tasks!</h4>
        <p>Click "Add Task" to create your first task and get organized.</p>
    </div>
    {% endfor %}
</div>

<!-- Task Detail Modal (Template for JavaScript) -->
<div id="task-detail-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title"></h2>
            <button id="modal-close-btn" class="close-modal" aria-label="Close task details">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modal-description"></p>
            <div class="modal-meta">
                <div class="meta-item">
                    <strong><i class="fas fa-flag"></i> Priority:</strong>
                    <span id="modal-priority"></span>
                </div>
                <div class="meta-item">
                    <strong><i class="fas fa-info-circle"></i> Status:</strong>
                    <span id="modal-status"></span>
                </div>
                <div class="meta-item">
                    <strong><i class="fas fa-calendar-plus"></i> Created:</strong>
                    <span id="modal-created-date"></span>
                </div>
                 <div class="meta-item">
                    <strong><i class="fas fa-calendar-times"></i> Due Date:</strong>
                    <span id="modal-due-date"></span>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            {# These actions will be dynamically linked by JavaScript #}
            <form id="modal-delete-form" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn-delete-task">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </form>
            <button type="button" id="modal-edit-btn" class="btn-edit-task" onclick="openEditTaskModal(0)">
                <i class="fas fa-edit"></i> Edit Task
            </button>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
    {# Add JavaScript here to handle modal pop-up and data fetching #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const taskCards = document.querySelectorAll('.my-task-card');
            const modal = document.getElementById('task-detail-modal');
            const closeModalBtn = document.getElementById('modal-close-btn');

            if (!modal) return;

            // Function to open the modal and fetch data
            const openModal = async (card) => {
                const taskId = card.dataset.taskId;
                // For now, let's just populate with static data as an example
                // In a real app, you would fetch from: card.dataset.taskDetailUrl
                
                // --- This is where you would fetch data from Django ---
                // const response = await fetch(`/task/${taskId}/`);
                // const data = await response.json();
                
                // Populate modal (using static data for this example)
                document.getElementById('modal-title').textContent = card.querySelector('.card-title').textContent;
                document.getElementById('modal-description').textContent = 'This is a detailed description fetched from the server for the selected task.';
                // ... populate other fields ...

                // Set dynamic URLs for actions
                document.getElementById('modal-delete-form').action = `/task/${taskId}/delete/`;
                // Update edit button to call the edit modal with the correct task ID
                document.getElementById('modal-edit-btn').onclick = () => openEditTaskModal(taskId);

                modal.style.display = 'flex';
            };

            // Function to close the modal
            const closeModal = () => {
                modal.style.display = 'none';
            };

            taskCards.forEach(card => {
                card.addEventListener('click', () => openModal(card));
            });

            closeModalBtn.addEventListener('click', closeModal);

            // Close modal if clicking on the overlay
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === "Escape") {
                    closeModal();
                }
            });
        });
    </script>
{% endblock scripts %}